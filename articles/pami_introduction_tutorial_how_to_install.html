<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Getting Started with the PAMI: PHP Asterisk Manager Interface</title>
<meta name="Author" content="Marcelo Gornstein"/>
<meta name="Keywords" content="pami php asterisk manager interface ami install configuration how to setup"/>
<meta name="description" content="This article will show how to download and install the pami: php asterisk manager interface, a small tutorial to write easy telephony applications"/>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../images/favicon.ico" title="favicon" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="all" />
<link href='../dphighlighter/SyntaxHighlighter.css' rel='stylesheet' type='text/css' />
<!--[if IE]>
<link type="text/css" rel="stylesheet" media="screen" href="../css/fix-ie.css" />
<![endif]-->
<!--[if IE 6]>
<script type="text/javascript" src="../js/fix-png.js"></script>
<![endif]-->
<script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script>
<script type="text/javascript" src="../js/lib/jquery-core.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
</head>
<body>
<div id="wrapper">
  <div id="top">
    <!-- <a class="logo" href="index.html">Marcelo G</a>-->
    <ul id="nav">
      <li><a href="../index.html"><span>Home</span></a></li>
      <li><a href="../about.html"><span>About</span></a></li>
      <li class="active"><a href="articles.html"><span>Articles</span></a></li>
      <li><a href="../software.html"><span>Software</span></a></li>
      <li><a href="mailto:marcelog@gmail.com"><span>Contact</span></a></li>
    </ul>
  </div>
  <div class="header">
  	<div class="line">
      <h1>Articles</h1>
      <div class="social-network">
       <a href="mailto:marcelog@gmail.com" class="icon-email" title="Email">Email</a>
       <g:plusone></g:plusone>
      </div>
   	</div>
    <div class="breadcrumb">You are here &nbsp;&raquo;&nbsp; <a href="../index.html">Home Page</a>  &nbsp;&raquo;&nbsp;  <a href="articles.html">Articles</a>  &nbsp;&raquo;&nbsp;  Getting Started with the PAMI: PHP Asterisk Manager Interface</div>
  </div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6947936742546167"
     data-ad-slot="2769853059"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  <div class="main-outer">
  	<div class="main-inner">
    	<div class="main">
      	<div class="line">
          <div id="content">
            <div class="mod simple article-detail-style">
              <span class="top"><span class="tl"></span><span class="tr"></span></span>
              <div class="inner set-height-1">
                <h2>Getting Started with the PAMI: PHP Asterisk Manager Interface = Easy Asterisk Monitoring</h2>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="mgornstein" data-size="large" data-related="mgornstein">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="hr-1"><hr /></div>
<p>
<a href='https://pledgie.com/campaigns/30944'><img alt='Click here to lend your support to: PAMI and make a donation at pledgie.com !' src='https://pledgie.com/campaigns/30944.png?skin_name=chrome' border='0' ></a>
</p>
<h3>Introduction</h3>
<p>
<a href="http://marcelog.github.com/PAMI">PAMI</a> is a PHP 5.3 client for <a href="http://marcelog.github.com/articles/php_asterisk_manager_interface_protocol_tutorial_introduction.html">AMI:
Asterisk Manager Interface</a>. <a href="http://www.digium.com">Asterisk</a> is one of the hot topics in the IT world due to its broad acceptance and use case scenarios.
</p>
<p>
<b>UPDATE</b>: <a href="http://www.slideshare.net/mgornstein/phpconf-2013">Check the slides</a> about writing telephony applications using Asterisk, PHP, and PAGI and PAMI, at the PHP Conference Argentina 2013. You can download the slides, <b>don't forget to see the notes!</b> The complete talk is right there if you missed it :)
</p>
<p>
PAMI will let you use the AMI interface to control and monitor your asterisk box(es) in a pretty easy way. Also, it supports <a href="http://www.moythreads.com/wordpress/2007/12/24/asterisk-asynchronous-agi/">Asynchronous AGI</a>,
so its even suitable to create a complete IVR solution.
</p>
<p>
With PAMI you receive <a href="http://www.voip-info.org/wiki/view/asterisk+manager+events">events</a>, and send <a href="http://www.voip-info.org/wiki/view/Asterisk+manager+API">actions</a>. Each action
is a command (for example, issue a dial or hangup an ongoing call). The events, on the other hand, are issued by asterisk whenever something interesting occurs in the
system.
</p>
<p>
You will send the actions through the <a href="http://ci.marcelog.name:8080/job/PAMI/javadoc/db_Client_IClient.html#%5CPAMI%5CClient%5CIClient">pami client</a>. This is a synchronous operation,
the process will block until the response has arrived. To get the events, just register an event listener (more on this after the installation instructions).
</p>
<h3>Getting it</h3>
<p>
First, a couple of useful links:
<ul>
<li><u><a href="http://marcelog.github.com/PAMI">http://marcelog.github.com/PAMI/</a></u>: The homepage.</li>
<li><u><a href="http://packagist.org/packages/marcelog/pami">http://packagist.org/packages/marcelog/pami</a></u>: Packagist home
<li><u><a href="https://github.com/marcelog/PAMI">https://github.com/marcelog/PAMI/</a></u>: The GitHub repository</li>
<li><u><a href="https://github.com/marcelog/PAMI/tree/master/doc/examples">Full PAMI examples</a></u></li>
<li><u><a href="http://marcelog.github.com/articles/php_asterisk_manager_interface_protocol_tutorial_introduction.html">AMI Protocol article</a></u></li>
<li><u><a href="http://marcelog.github.com/articles/php_asterisk_listener_example_using_pami_and_ding.html">http://marcelog.github.com/articles/php_asterisk_listener_example_using_pami_and_ding.html</a></u>: A more advanced pami application, using ding as DI container to
capture events.</li>
</ul>
</p>
<h3>For PHP 5.3.9 and 5.3.10 users</h3>
<p><b>NOTE</b>:Be sure that your PHP version is not 5.3.9 or 5.3.10, beacuse they had a bug in stream_get_line() that will prevent PAMI from working correctly. Please use a different 5.3 or 5.4 version. If you really need a patch, just email me or see <a href="https://github.com/marcelog/PAMI/blob/master/README.PHP-5.3.9-and-5.3.10">this</a>.</p>
<h3>Installing</h3>
<p>
PAMI is available via composer, please see <a href="https://github.com/marcelog/PAMI">the repo README file</a> for instructions on how to use it.
</p>
<p>
Packagist URL: <a href="http://packagist.org/packages/marcelog/pami">http://packagist.org/packages/marcelog/pami</a>
</p>

<h3>Let the fun begin!</h3>
<p>
In your <a href="http://www.asteriskguru.com/tutorials/manager_conf.html">manager.conf</a> file, create a user with
permissions to access ami. In the following example, the user admin, has ALL permissions granted (beware!). This is the
username that we are going to use from pami:
</p>
<pre name="code" class="php">
[admin]
secret = mysecret
deny=0.0.0.0/0.0.0.0
permit=127.0.0.1/255.255.255.0
read = system,call,log,verbose,agent,user,config,dtmf,reporting,cdr,dialplan
write = system,call,agent,log,verbose,user,config,command,reporting,originate

</pre>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6947936742546167"
     data-ad-slot="6142121850"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h3>Connecting to AMI</h3>
<p>
Working with pami is pretty straightforward. You need to get an instance of an <a href="https://github.com/marcelog/PAMI/blob/master/src/PAMI/Client/IClient.php">IClient</a> implementation. Currently,
the only implementation is <a href="https://github.com/marcelog/PAMI/blob/master/src/PAMI/Client/Impl/ClientImpl.php">ClientImpl</a>. A client will let you do this:
<ul>
<li>Open the connection to asterisk AMI</li>
<li>Close the connection to asterisk AMI</li>
<li>Register an event listener</li>
<li>Unregister an event listener</li>
</ul>
</p>
<p>
In order to get the client instance and open the connection, you need to provide the connection options through an array:
</p>
<pre name="code" class="php">
/* These are (in order) the options we can pass to pami client:
 *
 * The hostname or ip address where asterisk ami is listening
 * The scheme can be tcp:// or tls://
 * The port where asterisk ami is listening
 * Username configured in manager.conf
 * Password configured for the above user
 * Connection timeout in milliseconds
 * Read timeout in milliseconds
 */
$pamiClientOptions = array(
    'host' => '127.0.0.1',
    'scheme' => 'tcp://',
    'port' => 9999,
    'username' => 'admin',
    'secret' => 'mysecret',
    'connect_timeout' => 10000,
    'read_timeout' => 10000
);

use PAMI\Client\Impl\ClientImpl as PamiClient;
$pamiClient = new PamiClient($pamiClientOptions);

// Open the connection
$pamiClient->open();

// Close the connection
$pamiClient->close();
</pre>
<p>
Easy, isn't it?
</p>
<h3>Listening for events</h3>
<p>
In order to get events, you need to register an event listener. There are 3 possible ways to register an event
listener, all of them using the registerEventListener() method of the IClient implementation, and
your listener will receive <a href="https://github.com/marcelog/PAMI/blob/master/src/PAMI/Message/Event/EventMessage.php">EventMessage</a> objects.
</p>
<p>
You can have as many listeners as you want, and mix them however you need.
</p>
<ul>
<li>Register a <a href="http://us.php.net/closure">Closure</a></li>
<pre name="code" class="php">
use PAMI\Message\Event\EventMessage;
$pamiClient->registerEventListener(function (EventMessage $event) {
    var_dump($event);
});
</pre>
<li>Register a specific method of an object</li>
<pre name="code" class="php">
use PAMI\Message\Event\EventMessage;
class MyListener
{
    public function handlerMethod(EventMessage $event)
    {
        var_dump($event);
    }
}
$listener = new MyListener();
$pamiClient->registerEventListener(array(
    $listener, 'handlerMethod'
));
</pre>
<li>Register an object, that implements <a href="https://github.com/marcelog/PAMI/blob/master/src/PAMI/Listener/IEventListener.php">IEventListener</a></li>
<pre name="code" class="php">
use PAMI\Message\Event\EventMessage;
use PAMI\Listener\IEventListener;
class MyOtherListener implements IEventListener
{
    public function handle(EventMessage $event)
    {
        var_dump($event);
    }
}
$listener = new MyOtherListener();
$pamiClient->registerEventListener($listener);
</pre>
</ul>
</p>
<p>
In order for pami to receive the events, you need to periodically call the process() method, like:
</p>
<pre name="code" class="php">
$running = true;

while($running) {
    $pamiClient->process();
    usleep(1000);
}
</pre>
<p>
If you dont like having a main loop like that, try using <a href="http://us.php.net/register_tick_function">register_tick_function()</a> instead:
</p>
<pre name="code" class="php">
register_tick_function(array($pamiClient, 'process'));
</pre>
<p>
This will require to use <a href="http://us.php.net/declare">declare(ticks=1)</a> at the top of your source file.
</p>
<h3>Putting it all together</h3>
<pre name="code" class="php">
use PAMI\Client\Impl\ClientImpl as PamiClient;
use PAMI\Message\Event\EventMessage;
use PAMI\Listener\IEventListener;

$pamiClientOptions = array(
    'host' => '127.0.0.1',
    'scheme' => 'tcp://',
    'port' => 9999,
    'username' => 'admin',
    'secret' => 'mysecret',
    'connect_timeout' => 10000,
    'read_timeout' => 10000
);

$pamiClient = new PamiClient($pamiClientOptions);

// Open the connection
$pamiClient->open();

$pamiClient->registerEventListener(function (EventMessage $event) {
    var_dump($event);
});

$running = true;

// Main loop
while($running) {
    $pamiClient->process();
    usleep(1000);
}

// Close the connection
$pamiClient->close();
</pre>
<h3>Filtering incoming events</h3>
<p>
Up to now, we've only seen how to register event listeners. These listeners will receive <b>ALL</b> the
events that get to pami. What happens if we only want some events, or there is some important condition to
be met before receiving the events? That's where predicates come to the rescue. When registering an event
listener, an optional closure can be passed as argument that will be the predicate. If the predicate returns
true, the event will be dispatched. If the predicate returns false, the event wont get to the listener:
</p>
<pre name="code" class="php">
use PAMI\Message\Event\DialEvent;
$pamiClient->registerEventListener(
    function (EventMessage $event) {
        var_dump($event);
    },
    function (EventMessage $event) {
        return
            $event instanceof DialEvent
            && $event->getSubEvent() == 'Begin'
        ;
    }
);
</pre>
<p>
In this case, our predicate will only return true if and only if the event received is DialEvent, and the
subevent type is a begin (i.e: an agi application has issued a Dial() command). You can only add 1 predicate (per listener, but you can have multiple listeners), but you can make it as complex as as you wish, and as a result, your event listener will be a little cleaner.
</p>
<p>
By the way, <a href="https://github.com/marcelog/PAMI/tree/master/src/PAMI/Message/Event">here are all the events available</a>.
</p>
<h3>More fun: Send actions</h3>
<p>
You can also send actions to asterisk. An action is just an object of a given type. You can see all the actions
available <a href="https://github.com/marcelog/PAMI/tree/master/src/PAMI/Message/Action">here</a> and the asterisk wiki with their
<a href="https://wiki.asterisk.org/wiki/display/AST/AMI+Actions">official list of actions</a>. Let's send a
<a href="https://github.com/marcelog/PAMI/blob/master/src/PAMI/Message/Action/ReloadAction.php">Reload</a> action:
</p>
<pre name="code" class="php">
use PAMI\Message\Action\ReloadAction;
$response = $pamiClient->send(new ReloadAction());
if ($response->isSuccess()) {
    echo "Ok!\n";
} else {
    echo "Failed!\n"
}
</pre>
<p>
The result of the action sent, will come as a <a href="https://github.com/marcelog/PAMI/blob/master/src/PAMI/Message/Response/ResponseMessage.php">Response</a> message.
</p>

<H3>Conclusion</H3>
<p>
PAMI is simple and straightforward. I hope you have fun using it, just as I had when
writing it! A component like this can open a lot of new possibilities to your cli and
webapp applications.
</p>
              </div>
            </div>
            <div class="mod view-more">
              <div class="inner">
                <a href="articles.html">Read Other Articles</a>
              </div>
              <span class="bottom"><span class="bl"></span><span class="br"></span></span>
            </div>
          </div>
          <div id="sidebar" class="highlight articles-style original">
            <div class="mod simple">
              <span class="top"><span class="tl"></span><span class="tr"></span></span>
              <div class="inner set-height-1">
<p>
If you liked this or other articles (and feel generous), you can make a donation:
</p>
<p>
<a href='https://pledgie.com/campaigns/30947'><img alt='Click here to lend your support to: General and make a donation at pledgie.com !' src='https://pledgie.com/campaigns/30947.png?skin_name=chrome' border='0' ></a>
</p>
                <div class="google-ads">
                    <script type="text/javascript">
                    google_ad_client = "ca-pub-6947936742546167";
                    /* 9 */
                    google_ad_slot = "8617829895";
                    google_ad_width = 250;
                    google_ad_height = 250;
                    //-->
                    </script>
                    <script type="text/javascript"
                    src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                    </script>
                </div>
              	<h2>Related Articles</h2>
                <div class="hr-1"><hr /></div>
                <ul class="quick-list">
                  <li><a href="making_your_ivr_nodes_call_flow_with_pagi_and_php_asterisk.html">Making your ivr nodes (call) flow with PAGI</a></li>
                  <li><a href="pagi_node_call_flow_easy_telephony_application_for_asterisk_php.html">Advanced telephony applications with PHP and PAGI using call flow nodes</a></li>
                  <li><a href="pagi_mock_client_unit_test_ivr_application_telephony_asterisk_agi.html">Unit test your PHP IVR applications with PAGI</a></li>
                  <li><a href="php_asterisk_agi_protocol_tutorial.html">AGI (Asterisk Gateway Interface) Protocol Tutorial And Quick Practical Approach</a></li>
                  <li><a href="php_asterisk_manager_interface_protocol_tutorial_introduction.html">AMI (Asterisk Manager Interface) Protocol Tutorial</a></li>
                  <li><a href="php_asterisk_listener_example_using_pami_and_ding.html">Making an Asterisk Manager Interface monitor using PHP, PAMI, and Ding (Inversion of control and dependency injection in your php telephony applications)</a></li>
                  <li><a href="bash_asterisk_manager_interface_client_shell_script.html">Bami: A Proof of concept asterisk manager interface (AMI) client written in bash</a></li>
                  <li><a href="pagi_tutorial_create_voip_telephony_application_for_asterisk_with_agi_and_php.html">PAGI: Quick telephony applications using AGI and PHP</a></li>
                </ul>
              </div>
              <span class="bottom"><span class="bl"></span><span class="br"></span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footer">
  	<!-- <p>&copy; 2010 Marcelo G. All Rights Reserved. Website design by <a href="http://Digitallabs.tv" target="_blank">Digitallabs.tv</a></p> -->
    <address>Email: <a href="mailto:marcelog@gmail.com">marcelog@gmail.com</a></address>
  </div>
</div>

<!-- config SyntaxHighlighter -->
<script src='../dphighlighter/shCore.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushPhp.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushXml.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushJScript.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushCss.js' type='text/javascript'></script>
<script language="javascript">
    dp.SyntaxHighlighter.ClipboardSwf = '../dphighlighter/clipboard.swf';
    dp.SyntaxHighlighter.HighlightAll('code');
</script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21070993-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
