<html>
  <head>
  <!-- AÃ±ade esta etiqueta en la cabecera o delante de la etiqueta body. -->
<script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script>
  	<meta name="description" content="This article is a tutorial about how to mock php global functions for unit testing with phpunit."/>
  

  <title>Mocking global php functions for unit testing</title>
  
  </head>
  <body>
  <H1><u>Introduction</u></H1>
  <p>
Let's say you'd like to achieve a 100% <b>coverage</b> of your code in your <b>php</b> application (you obsessive geek..). It's almost
certain you'll need to start mock'ing things around. So far so good.. but sooner or later you will need to deal with the test cases
for the code that use <b>global</b> php <b>functions</b>. How can you mock them? In this article I'll show you a small
technique to allow you to <b>mock global php functions</b>. This will
require your code to use <b>namespaces</b>, available since <b>PHP 5.3</b>.
</p>
  <center>
  <script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* 6 */
google_ad_slot = "1974587443";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>
<center>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* links1 */
google_ad_slot = "7432160740";
google_ad_width = 728;
google_ad_height = 15;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>	
<H1><u>Classical example</u></H1>
<p>
<g:plusone></g:plusone>
Suppose this is the code you'd like to test, a file called SomeClass.php:
<pre>
namespace My\Nice\Namezpace;

class SomeClass
{
    public function doSomething()
    {
        // Notice how the global function "socket_create" is called without
        // the leading backslash (relative instead of absolute call in a 
        // namespaced environment). This will let us later mock the call 
        // by taking advantage of the relative-to-the-namespace call.
        $socket = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP);
        if ($socket === false) {
            throw new \Exception('Ooops!');
        }
        socket_close($socket);
        return true;
    }

    public function __construct()
    {
    }
}
</pre>
</p>
<p>
It's fairly easy to have a unit test for the "success case" by just asserting
the result value. What happens with the other use case, where the exception is
thrown? <br/>
This is an extreme simple example, but what happens if something complicated
has to be done when the call to <b>socket_create</b> fails for whatever reason? How can
you be sure that the code is behaving like it should be?<br/>
</p>
<center>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* links1 */
google_ad_slot = "7432160740";
google_ad_width = 728;
google_ad_height = 15;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>   
<H1><u>The tests</u></H1>
<p>
This is our Test_SomeClass.php file:

<pre>
namespace {
    // This allow us to configure the behavior of the "global mock"
    $mockSocketCreate = false;
}

namespace My\Nice\Namezpace {
    // And this here, does the trick: it will override the socket_create()
    // function in your code *just for the namespace* where you are defining it.
    // This relies on the code above calling the socket_create function without
    // the leading backslash, so we trick SomeClass into calling our own function
    // inside that namespace instead of the global socket_create function.
    function socket_create() {
        global $mockSocketCreate;
        if (isset($mockSocketCreate) && $mockSocketCreate === true) {
            return false;
        } else {
            return call_user_func_array('\socket_create', func_get_args());
        }
    }

include_once './SomeClass.php';

class Test_SomeClass extends \PHPUnit_Framework_TestCase
{
    public function setUp()
    {
        global $mockSocketCreate;
        $mockSocketCreate = false;
    }

    /**
     * This will test the success case.
     * @test
     */
    public function can_success_case()
    {
        $dummy = new \My\Nice\Namezpace\SomeClass;
        $this->assertTrue($dummy->doSomething());
    }

    /**
     * This will enable the mock and call the code. socket_create will now
     * return false instead the call of the original socket_create, our work
     * here is done.
     * @test
     * @expectedException \Exception
     */
    public function cannot_error_case()
    {
        global $mockSocketCreate;
        $mockSocketCreate = true;
        $dummy = new \My\Nice\Namezpace\SomeClass;
        $dummy->doSomething();
        $this->fail('Should not here');
    }
}
}
</pre>
</p>
<p>
Running phpunit will give you the 100% coverage :)
<pre>
phpunit --debug --process-isolation --verbose --stop-on-incomplete --stop-on-skipped --stop-on-failure --stop-on-error --colors --coverage-html html Test_SomeClass.php
</pre>
</p>
<center>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* links1 */
google_ad_slot = "7432160740";
google_ad_width = 728;
google_ad_height = 15;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>   

<H1><u>Conclusions</u></H1>
With this little trick we can increase the testing level of the code. Most "normal" php code lacks good error
handling (differences between cero, false, and null are among the #1's). Now everything can be tested at the highest
levels possible, which is a novelty in the php language :) now go get that 100%!
<br/>

<H1><u>Author</u></H1>
Marcelo Gornstein &lt;marcelog@gmail.com&gt;<br/>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21070993-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>