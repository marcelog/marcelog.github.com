<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Mocking global php functions for unit testing</title>
<meta name="Author" content="Marcelo Gornstein"/>
<meta name="Keywords" content="This article is a tutorial about how to mock php global functions for unit testing with phpunit."/>
<meta name="description" content="This article is a tutorial about how to mock php global functions for unit testing with phpunit."/>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../images/favicon.ico" title="favicon" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="all" />
<link href='../dphighlighter/SyntaxHighlighter.css' rel='stylesheet' type='text/css' />
<!--[if IE]>
<link type="text/css" rel="stylesheet" media="screen" href="../css/fix-ie.css" />
<![endif]-->
<!--[if IE 6]>
<script type="text/javascript" src="../js/fix-png.js"></script>
<![endif]-->
<script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script>
<script type="text/javascript" src="../js/lib/jquery-core.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
</head>
<body>
<div id="wrapper">
  <div id="top">
    <!-- <a class="logo" href="index.html">Marcelo G</a>-->
    <ul id="nav">
      <li><a href="../index.html"><span>Home</span></a></li>
      <!-- <li><a href="../about.html"><span>About</span></a></li>  -->
      <li class="active"><a href="articles.html"><span>Articles</span></a></li>
      <li><a href="../software.html"><span>Software</span></a></li>
      <li><a href="mailto:marcelog@gmail.com"><span>Contact</span></a></li>
    </ul>
  </div>
  <div class="header">
  	<div class="line">
      <h1>Articles</h1>
      <div class="social-network">
       <a href="mailto:marcelog@gmail.com" class="icon-email" title="Email">Email</a>
       <g:plusone></g:plusone>
      </div>
   	</div>
    <div class="breadcrumb">You are here &nbsp;&raquo;&nbsp; <a href="../index.html">Home Page</a>  &nbsp;&raquo;&nbsp;  <a href="articles.html">Articles</a>  &nbsp;&raquo;&nbsp;  Mocking global php functions for unit testing</div>
  </div>
  <div class="main-outer">
  	<div class="main-inner">
    	<div class="main">
      	<div class="line">
          <div id="content">
            <div class="mod simple article-detail-style">
              <span class="top"><span class="tl"></span><span class="tr"></span></span>
              <div class="inner set-height-1">
                <h2>Mocking Global Php 5.3 Functions Using Namespaces</h2>
                <div class="hr-1"><hr /></div>
  <H3><u>Introduction</u></H3>
  <p>
Let's say you'd like to achieve a 100% <b>coverage</b> of your code in your <b>php</b> application (you obsessive geek..). It's almost
certain you'll need to start mock'ing things around. So far so good.. but sooner or later you will need to deal with the test cases
for the code that use <b>global</b> php <b>functions</b>. How can you mock them? In this article I'll show you a small
technique to allow you to <b>mock global php functions</b>. This will
require your code to use <b>namespaces</b>, available since <b>PHP 5.3</b>.
</p>

<H3><u>Classical example</u></H3>
<p>
Suppose this is the code you'd like to test, a file called SomeClass.php:
<pre name="code" class="php">
namespace My\Nice\Namezpace;

class SomeClass
{
    public function doSomething()
    {
        // Notice how the global function "socket_create" is called without
        // the leading backslash (relative instead of absolute call in a
        // namespaced environment). This will let us later mock the call
        // by taking advantage of the relative-to-the-namespace call.
        $socket = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP);
        if ($socket === false) {
            throw new \Exception('Ooops!');
        }
        socket_close($socket);
        return true;
    }

    public function __construct()
    {
    }
}
</pre>
</p>
<p>
It's fairly easy to have a unit test for the "success case" by just asserting
the result value. What happens with the other use case, where the exception is
thrown? <br/>
This is an extreme simple example, but what happens if something complicated
has to be done when the call to <b>socket_create</b> fails for whatever reason? How can
you be sure that the code is behaving like it should be?<br/>
</p>

<H1><u>The tests</u></H1>
<p>
This is our Test_SomeClass.php file:

<pre name="code" class="php">
namespace {
    // This allow us to configure the behavior of the "global mock"
    $mockSocketCreate = false;
}

namespace My\Nice\Namezpace {
    // And this here, does the trick: it will override the socket_create()
    // function in your code *just for the namespace* where you are defining it.
    // This relies on the code above calling the socket_create function without
    // the leading backslash, so we trick SomeClass into calling our own function
    // inside that namespace instead of the global socket_create function.
    function socket_create() {
        global $mockSocketCreate;
        if (isset($mockSocketCreate) && $mockSocketCreate === true) {
            return false;
        } else {
            return call_user_func_array('\socket_create', func_get_args());
        }
    }

include_once './SomeClass.php';

class Test_SomeClass extends \PHPUnit_Framework_TestCase
{
    public function setUp()
    {
        global $mockSocketCreate;
        $mockSocketCreate = false;
    }

    /**
     * This will test the success case.
     * @test
     */
    public function can_success_case()
    {
        $dummy = new \My\Nice\Namezpace\SomeClass;
        $this->assertTrue($dummy->doSomething());
    }

    /**
     * This will enable the mock and call the code. socket_create will now
     * return false instead the call of the original socket_create, our work
     * here is done.
     * @test
     * @expectedException \Exception
     */
    public function cannot_error_case()
    {
        global $mockSocketCreate;
        $mockSocketCreate = true;
        $dummy = new \My\Nice\Namezpace\SomeClass;
        $dummy->doSomething();
        $this->fail('Should not here');
    }
}
}
</pre>
</p>
<p>
Running phpunit will give you the 100% coverage :)
</p>
<pre name="code" class="php">
phpunit --debug --process-isolation --verbose --stop-on-incomplete --stop-on-skipped --stop-on-failure --stop-on-error --colors --coverage-html html Test_SomeClass.php
</pre>
<H3><u>Conclusions</u></H3>
<p>
With this little trick we can increase the testing level of the code. Most "normal" php code lacks good error
handling (differences between cero, false, and null are among the #1's). Now everything can be tested at the highest
levels possible, which is a novelty in the php language :) now go get that 100%!
</p>
<br/>

              </div>
            </div>
            <div class="mod view-more">
              <div class="inner">
                <a href="articles.html">Read Other Articles</a>
              </div>
              <span class="bottom"><span class="bl"></span><span class="br"></span></span>
            </div>
          </div>
          <div id="sidebar" class="highlight articles-style original">
            <div class="mod simple">
              <span class="top"><span class="tl"></span><span class="tr"></span></span>
              <div class="inner set-height-1">
                <h2>Related Articles</h2>
                <div class="hr-1"><hr /></div>
                <ul class="quick-list">
                  <li><a href="ci_jenkins_hudson_continuous_integration_php_phing.html">PHP Continuous integration, with Jenkins and Phing</a></li>
                  <li><a href="pagi_mock_client_unit_test_ivr_application_telephony_asterisk_agi.html">Unit test your PHP IVR applications with PAGI</a></li>
                  <li><a href="creating_php_cli_standalone_portable_applications_with_pear_dependencies.html"> Creating isolated environments for PHP applications with PEAR dependencies</a></li>
                  <li><a href="php_applications_with_doctrine2_orm_and_ding_di_container.html">Writing PHP applications with Doctrine2 as ORM and Ding as DI container</a></li>
                </ul>
                <div class="google-ads">
                    <script type="text/javascript">
                    google_ad_client = "ca-pub-6947936742546167";
                    /* 9 */
                    google_ad_slot = "8617829895";
                    google_ad_width = 250;
                    google_ad_height = 250;
                    //-->
                    </script>
                    <script type="text/javascript"
                    src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                    </script>
                </div>
              </div>
              <span class="bottom"><span class="bl"></span><span class="br"></span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footer">
  	<!-- <p>&copy; 2010 Marcelo G. All Rights Reserved. Website design by <a href="http://Digitallabs.tv" target="_blank">Digitallabs.tv</a></p> -->
    <address>Email: <a href="mailto:marcelog@gmail.com">marcelog@gmail.com</a></address>
  </div>
</div>

<!-- config SyntaxHighlighter -->
<script src='../dphighlighter/shCore.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushPhp.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushXml.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushJScript.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushCss.js' type='text/javascript'></script>
<script language="javascript">
    dp.SyntaxHighlighter.ClipboardSwf = '../dphighlighter/clipboard.swf';
    dp.SyntaxHighlighter.HighlightAll('code');
</script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21070993-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>