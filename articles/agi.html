<html>
  <head>
  	<meta name="description" content="This article is about the Asterisk Gateway Interface protocol. It aims to be a practical approach, tutorial, and how-to about AGI, helpful to learn how to make asterisk agi applications."/>
  
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21070993-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
  <title>The Asterisk Gateway Protocol: A practical introduction and tutorial to agi applications</title>
  
  </head>
  <body>
  <H1><u>Introduction</u></H1>
  <p>
The <b>Asterisk Gateway Protocol</b> (AGI from now on) is the protocol used by the Asterisk server as its interface for telephony applications.<br/><br/>
AGI is just a way that allows you (as a software developer) to easily make telephony applications that asterisk will run someway along
the dialplan. Through <b>AGI</b>, you can read input from the user, play sound files, control the call and its flow, and pretty much everything
needed to make a successfull <u>IVR</u> (<b>Interactive Voice Response</b>) in virtually any programming language.
</p>
<p>
You might also be interested in <a href="http://marcelog.github.com/PAGI">PAGI</a>. An AGI client/framework that allows you to
quickly develop agi applications in an oop fashion.
</p>
  <center>
  <script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* 6 */
google_ad_slot = "1974587443";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>
<H1><u>Asterisk configuration for AGI applications</u></H1>
To start your agi application you will use the AGI() dialplan application from you own dialplan. For example, in <b>extensions.conf:</b><br/>
exten =&gt; 1,1,AGI(myApplication.php)<br/>
  <p>
This will tell asterisk to start an agi application when a call is made to the '1' extension. That's it ;)
  </p>
  <H1><u>Overview of the AGI Protocol</u></H1>
  <p>
AGI is a very simple protocol. Asterisk communicate with the applications through their standard input
(stdin) and standard output (stdout). So you can send commands to asterisk via your stdout and receive
asterisk responses through your stdin. This makes AGI very easy to deal with from any programming language.
</p>
<p>
When a call is received by asterisk, it will start to execute the dial plan in the configured
context. This context will depend on various reasons that escape the scope of this article, so I wont
get into any details. <br/>
When the AGI() application is called from the dialplan, asterisk will fork() a new process
and execute that application, communicating (as stated above) with it through its standard
input and standard output (normally file descriptors 0 -zero- and 1 respectively).
</p>
<p>
Before forking and executing the new agi process, asterisk will set the following
environment variables:<br/>
<ul>
<li><u>AST_CONFIG_DIR</u>: astetcdir key from asterisk.conf.</li>
<li><u>AST_CONFIG_FILE</u>: absolute path to the asterisk.conf file used.</li>
<li><u>AST_MODULE_DIR</u>: astmoddir key from asterisk.conf.</li>
<li><u>AST_SPOOL_DIR</u>: astspooldir key from asterisk.conf.</li>
<li><u>AST_MONITOR_DIR</u>: usually AST_SPOOL_DIR/monitor</li>
<li><u>AST_VAR_DIR</u>: astvarlibdir key from asterisk.conf.</li>
<li><u>AST_DATA_DIR</u>: astdbdir key from asterisk.conf.</li>
<li><u>AST_LOG_DIR</u>: astlogdir key from asterisk.conf.</li>
<li><u>AST_AGI_DIR</u>: astagidir key from asterisk.conf.</li>
<li><u>AST_KEY_DIR</u>: astkeydir key from asterisk.conf.</li>
<li><u>AST_RUN_DIR</u>: astrundir key from asterisk.conf.</li>
</ul>
</p>
<p>
As soon as your application is fork()ed from asterisk, it starts to receive the channel
variables via its standard input, which are:
<ul>
<li><u>agi_request</u>: The filename of your script.</li>
<li><u>agi_channel</u>: The originating channel.</li>
<li><u>agi_language</u>: The language code.</li>
<li><u>agi_type</u>: The originating channel type.</li>
<li><u>agi_uniqueid</u>: A unique ID for the call.</li>
<li><u>agi_version</u>: The version of Asterisk (since Asterisk 1.6).</li>
<li><u>agi_calleridv</u>: The caller ID number (or "unknown").</li>
<li><u>agi_calleridname</u>: The caller ID name (or "unknown").</li>
<li><u>agi_callingpres</u>: The presentation for the callerid.</li>
<li><u>agi_callingani2</u>: PRI Channels ani2 variable.</li>
<li><u>agi_callington</u>: The type of number used in PRI Channels.</li>
<li><u>agi_callingtns</u>: An optional 4 digit number (Transit Network Selector).</li>
<li><u>agi_dnid</u>: The dialed number id (or "unknown").</li>
<li><u>agi_rdnis</u>: The referring DNIS number (or "unknown").</li>
<li><u>agi_context</u>: Origin context in extensions.conf.</li>
<li><u>agi_extension</u>: The called number (dnis).</li>
<li><u>agi_priority</u>: The priority it was executed as in the dial plan.</li>
<li><u>agi_enhanced</u>: The flag value is 1.0 if started as an EAGI script, 0.0 otherwise.</li>
<li><u>agi_accountcode</u>: Account code of the origin channel.</li>
<li><u>agi_threadid</u>: Thread ID of the AGI script.</li>
</ul>
</p>
<p>
The variables come in the following format:<br/>
&lt;variable_name&gt;:&lt;space&gt;&lt;variable_value&gt;<br/>
Example:<br/>
agi_context: default<br/>
</p>
<H1><u>Quick shell example</u></H1>
Let's try a very basic example to see in action what we've covered so far:

<H2>Configure asterisk to run an example</H2>
<p>
Let's configure a demo application, adding 3 (optional, of course) arguments to it:
</p>
<hr/>
exten =&gt; 1,1,AGI(/tmp/agi.sh,arg1,arg2,arg3)<br/>
<hr/>
<H2>Create the agi application</H2>
<br/>
<hr/>
#!/bin/bash<br/>
<br/>
filedump=/tmp/dump.txt<br/>
<br/>
function log() {<br/>
    echo ${@} &gt;&gt; ${filedump}<br/>
}<br/>
<br/>
function dumpvar() {<br/>
    log "channel variable: ${1} = ${2}"<br/>
}<br/>
<br/>
log "------------ call start ------------"<br/>
dumpvar "config dir" ${AST_CONFIG_DIR}<br/>
dumpvar "configfile" ${AST_CONFIG_FILE}<br/>
dumpvar "module dir" ${AST_MODULE_DIR}<br/>
dumpvar "spool dir" ${AST_SPOOL_DIR}<br/>
dumpvar "monitor dir" ${AST_MONITOR_DIR}<br/>
dumpvar "var dir" ${AST_VAR_DIR}<br/>
dumpvar "data dir" ${AST_DATA_DIR}<br/>
dumpvar "log dir" ${AST_LOG_DIR}<br/>
dumpvar "agi dir" ${AST_AGI_DIR}<br/>
dumpvar "key dir" ${AST_KEY_DIR}<br/>
dumpvar "run dir" ${AST_RUN_DIR}<br/>
<br/>
line='init'<br/>
while [ "${#line}" -gt "2" ]; do<br/>
        read line<br/>
        log ${line}<br/>
done<br/>
log "------------ call done ------------"<br/>
exit 0<br/>
<hr/>
<H2>Run the application</H2>
<p>
Make a call to the '1' extension. Your agi application should run and create the
file /tmp/dump.txt with the output from the channel variables. This application does
nothing at all. It will end when asterisk sends an empty line, which marks the end of
the channel variables block.
</p>
<p>
Example of the file /tmp/dump.txt generated:<br/>
<hr/>
------------ call start ------------<br/>
channel variable: config dir = /export/users/marcelog/config/asterisk<br/>
channel variable: configfile = /export/users/marcelog/config/asterisk/asterisk.conf<br/>
channel variable: module dir = /usr/lib/asterisk/modules<br/>
channel variable: spool dir = /tmp/marcelog/asterisk/spool<br/>
channel variable: monitor dir = /tmp/marcelog/asterisk/spool/monitor<br/>
channel variable: var dir = /tmp/marcelog/asterisk<br/>
channel variable: data dir = /tmp/marcelog/asterisk<br/>
channel variable: log dir = /tmp/marcelog/asterisk/logs<br/>
channel variable: agi dir = /tmp/marcelog/asterisk/agi-bin<br/>
channel variable: key dir = /tmp/marcelog/asterisk/keys<br/>
channel variable: run dir = /tmp/marcelog/asterisk<br/>
agi_request: /tmp/agi.sh<br/>
agi_channel: SIP/marcelog-e00d2760<br/>
agi_language: ar<br/>
agi_type: SIP<br/>
agi_uniqueid: 1297542965.8<br/>
agi_version: 1.6.0.9<br/>
agi_callerid: marcelog<br/>
agi_calleridname: marcelog@mg<br/>
agi_callingpres: 0<br/>
agi_callingani2: 0<br/>
agi_callington: 0<br/>
agi_callingtns: 0<br/>
agi_dnid: 667<br/>
agi_rdnis: unknown<br/>
agi_context: default<br/>
agi_extension: 667<br/>
agi_priority: 2<br/>
agi_enhanced: 0.0<br/>
agi_accountcode:<br/>
agi_threadid: 1104922960<br/>
agi_arg_1: arg1<br/>
agi_arg_2: arg2<br/>
agi_arg_3: arg3<br/>
------------ call done ------------<br/>
<hr/>
</p>
<p>
Notice how asterisk passes the variables from the dialplan to your application (i.e:
the "special" channel variables <b>agi_arg_x</b> where x is the argument index).
</p>
  <center>
  <script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* 6 */
google_ad_slot = "1974587443";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>
<H1><u>Sending AGI commands and receiving responses</u></H1>
<p>
An example agi command that logs to the console is:<br/>
VERBOSE "message" 3
</p>
<p>
In this case, the command is "verbose", which accepts 2 arguments: the message to log, and the log level
needed in order to log the message. Asterisk can respond with something like:<br/>
200 result=1
</p>
<p>
So asterisk responses have a format. The format is:<br/>
&lt;error_code&gt;&lt;space&gt;result=&lt;result_data&gt;&lt;space&gt;[additional_data]
</p>
<p>
Meaning:<br/>
<ul>
  <li><u>error_code</u>: An integer number that indicates the result of the operation (see below).</li>
  <li><u>result_data</u>: The result value for the command executed.</li>
  <li><u>additional_data</u>: Optional additional data returned along with the result_data.</li>
</ul>
</p>
<p>
The error code can be one of:
<ul>
  <li><u>200</u>: Operation was completed successfully.</li>
  <li><u>510</u>: Invalid or unknown command.</li>
  <li><u>511</u>: The command cant be executed on a dead (closed, terminated, hung up) channel.</li>
  <li><u>520</u>: End of proper usage, when the command returns its syntax.</li>
</ul>
</p>
<p>
As an AGI script, you should always set the AGI variable <b>AGISTATUS</b> to one of: 
<ul>
<li>SUCCESS</li>
<li>FAILURE</li>
<li>HANGUP</li>
</ul>
</p>
<p>
That's about it, you can find the complete list of commands <a href="https://wiki.asterisk.org/wiki/display/AST/AGI+Commands">here.</a><br/>
</p>
<H1><u>Quick shell example: Part 2</u></H1>
Now let's modify the example, like this:<br/>
<hr/>
#!/bin/bash<br/>
<br/>
filedump=/tmp/dump.txt<br/>
<br/>
function log() {<br/>
    echo ${@} >> ${filedump}<br/>
}<br/>
<br/>
function dumpvar() {<br/>
    log "channel variable: ${1} = ${2}"<br/>
}<br/>
<br/>
function send() {<br/>
    log Sending: ${@}<br/>
    echo ${@}<br/>
    read line<br/>
    log "Got: ${line}"<br/>
}<br/>
<br/>
function answer() {<br/>
    send "ANSWER"<br/>
}<br/>
<br/>
function agilog() {<br/>
    send "VERBOSE" \"${@}\"<br/>
}<br/>
<br/>
function play() {<br/>
    send STREAM FILE ${1} "#"<br/>
}<br/>
<br/>
function setvariable() {<br/>
    send SET VARIABLE ${1} ${2}<br/>
}<br/>
<br/>
function hangup() {<br/>
    setvariable AGISTATUS SUCCESS<br/>
    send "HANGUP 16"<br/>
}<br/>
<br/>
callStatus=1<br/>
function callEnded() {<br/>
    if [ "${callStatus}" -eq "0" ]; then<br/>
        return<br/>
    fi<br/>
    callStatus=0<br/>
    agilog "Call ended abruptly"<br/>
    hangup<br/>
    exit 0<br/>
}<br/>
<br/>
<br/>
# Asterisk will send a SIGHUP signal when the user hangups the channel. In this<br/>
# example you can try it by waiting for the welcome audio message to finish or<br/>
# hangup before it finishes playing.<br/>
trap callEnded SIGHUP<br/>
log "------------ call start ------------"<br/>
dumpvar "config dir" ${AST_CONFIG_DIR}<br/>
dumpvar "configfile" ${AST_CONFIG_FILE}<br/>
dumpvar "module dir" ${AST_MODULE_DIR}<br/>
dumpvar "spool dir" ${AST_SPOOL_DIR}<br/>
dumpvar "monitor dir" ${AST_MONITOR_DIR}<br/>
dumpvar "var dir" ${AST_VAR_DIR}<br/>
dumpvar "data dir" ${AST_DATA_DIR}<br/>
dumpvar "log dir" ${AST_LOG_DIR}<br/>
dumpvar "agi dir" ${AST_AGI_DIR}<br/>
dumpvar "key dir" ${AST_KEY_DIR}<br/>
dumpvar "run dir" ${AST_RUN_DIR}<br/>
<br/>
line='init'<br/>
while [ "${#line}" -gt "2" ]; do<br/>
        read line<br/>
        log ${line}<br/>
done<br/>
answer<br/>
agilog Hello There<br/>
play welcome<br/>
hangup<br/>
log "------------ call done ------------"<br/>
exit 0<br/>
<hr/>
<p>
Example of the file /tmp/dump.txt generated:<br/>
------------ call start ------------<br/>
channel variable: config dir = /export/users/marcelog/config/asterisk<br/>
channel variable: configfile = /export/users/marcelog/config/asterisk/asterisk.conf<br/>
channel variable: module dir = /usr/lib/asterisk/modules<br/>
channel variable: spool dir = /tmp/marcelog/asterisk/spool<br/>
channel variable: monitor dir = /tmp/marcelog/asterisk/spool/monitor<br/>
channel variable: var dir = /tmp/marcelog/asterisk<br/>
channel variable: data dir = /tmp/marcelog/asterisk<br/>
channel variable: log dir = /tmp/marcelog/asterisk/logs<br/>
channel variable: agi dir = /tmp/marcelog/asterisk/agi-bin<br/>
channel variable: key dir = /tmp/marcelog/asterisk/keys<br/>
channel variable: run dir = /tmp/marcelog/asterisk<br/>
agi_request: /tmp/agi.sh<br/>
agi_channel: SIP/marcelog-e00d2760<br/>
agi_language: ar<br/>
agi_type: SIP<br/>
agi_uniqueid: 1297542965.8<br/>
agi_version: 1.6.0.9<br/>
agi_callerid: marcelog<br/>
agi_calleridname: marcelog@mg<br/>
agi_callingpres: 0<br/>
agi_callingani2: 0<br/>
agi_callington: 0<br/>
agi_callingtns: 0<br/>
agi_dnid: 667<br/>
agi_rdnis: unknown<br/>
agi_context: default<br/>
agi_extension: 667<br/>
agi_priority: 2<br/>
agi_enhanced: 0.0<br/>
agi_accountcode:<br/>
agi_threadid: 1104922960<br/>
agi_arg_1: arg1<br/>
agi_arg_2: arg2<br/>
agi_arg_3: arg3<br/>
<br/>
Sending: ANSWER<br/>
Got: 200 result=0<br/>
Sending: VERBOSE "Hello There"<br/>
Got: 200 result=1<br/>
Sending: STREAM FILE welcome #<br/>
Sending: VERBOSE "Call ended abruptly"<br/>
Got: 00 result=-1 endpos=3840<br/>
Sending: SET VARIABLE AGISTATUS SUCCESS<br/>
Got: 200 result=1<br/>
Sending: HANGUP 16<br/>
Got: 200 result=1<br/>
------------ call done ------------<br/>
</p>
<center>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-6947936742546167";
/* 1 */
google_ad_slot = "9799557604";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></center>
<H1><u>Conclusions</u></H1>
As you can see, its fairly easy to implement almost *any* ivr application very quickly and easy
via agi. One of the most important keys to the success of asterisk as a telephony software and
product. I hope this tutorial helps you out in making agi applications in your language of choice.<br/>
<br/>

<H1><u>Author</u></H1>
Marcelo Gornstein &lt;marcelog@gmail.com&gt;<br/>
</body>
</html>