<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>How to setup nginx to work with FastCGI and PHP 5.2 and PHP 5.3</title>
<meta name="Author" content="Marcelo Gornstein"/>
<meta name="Keywords" content="How to setup nginx to work with FastCGI and PHP 5.2 and PHP 5.3"/>
<meta name="description" content="This article will show how to setup nginx to use fastcgi with different php versions, like 5.2 and 5.3 per virtual host"/>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../images/favicon.ico" title="favicon" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="all" />
<link href='../dphighlighter/SyntaxHighlighter.css' rel='stylesheet' type='text/css' />
<!--[if IE]>
<link type="text/css" rel="stylesheet" media="screen" href="../css/fix-ie.css" />
<![endif]-->
<!--[if IE 6]>
<script type="text/javascript" src="../js/fix-png.js"></script>
<![endif]-->
<script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script>
<script type="text/javascript" src="../js/lib/jquery-core.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
</head>
<body>
<div id="wrapper">
  <div id="top">
    <!-- <a class="logo" href="index.html">Marcelo G</a>-->
    <ul id="nav">
      <li><a href="../index.html"><span>Home</span></a></li>
      <!-- <li><a href="../about.html"><span>About</span></a></li> -->
      <li class="active"><a href="articles.html"><span>Articles</span></a></li>
      <li><a href="../software.html"><span>Software</span></a></li>
      <li><a href="mailto:marcelog@gmail.com"><span>Contact</span></a></li>
    </ul>
  </div>
  <div class="header">
  	<div class="line">
      <h1>Articles</h1>
      <div class="social-network">
       <a href="mailto:marcelog@gmail.com" class="icon-email" title="Email">Email</a>
       <g:plusone></g:plusone>
      </div>
   	</div>
    <div class="breadcrumb">You are here &nbsp;&raquo;&nbsp; <a href="../index.html">Home Page</a>  &nbsp;&raquo;&nbsp;  <a href="articles.html">Articles</a>  &nbsp;&raquo;&nbsp;  How to setup nginx to work with FastCGI and PHP 5.2 and PHP 5.3</div>
  </div>
  <div class="main-outer">
  	<div class="main-inner">
    	<div class="main">
      	<div class="line">
          <div id="content">
            <div class="mod simple article-detail-style">
              <span class="top"><span class="tl"></span><span class="tr"></span></span>
              <div class="inner set-height-1">
                <h2>How to setup nginx to work with FastCGI and PHP 5.2 and PHP 5.3</h2>
                <div class="hr-1"><hr /></div>
  <H3><u>Introduction</u></H3>
  <p>
<a href="http://nginx.org/">Nginx</a> seems to be the new silver bullet nowadays, so I've decided
to give it a try. Of course it is fun to get it up and running and serve static content, but the
true fun is to see it replace <a href="http://httpd.apache.org">apache</a> or <a href="http://www.lighttpd.net/">lighttpd</a>
completely. And to make that happen, it has to support serving some dynamic content. In this article, I'll show
a very basic and quick setup for nginx, using <a href="http://en.wikipedia.org/wiki/FastCGI">FastCGI</a> to serve
PHP 5.2 and PHP 5.3 for different virtual hosts.
  </p>
  <p>
The idea here, is to compile versions 5.2 and 5.3 of php with FastCGI enabled. Once we get that, we can launch
both fastcgi daemons and let nginx connect to them. 
  </p>
  <H3><u>Configuration for PHP 5.2</u></H3>
  <p>
For PHP 5.2 you will need to configure (as in running ./configure before building) adding
the following options:
  </p>
  <pre name="code" class="php">
--enable-fastcgi --with-pcre --enable-mbstr-enc-trans --enable-mbstring
  </pre>
  <H3><u>Configuration for PHP 5.3</u></H3>
  <p>
For PHP 5.3, the configuration options are slightly different:
  </p>  
  <pre name="code" class="php">
--enable-cgi
  </pre>
  <p>
  This will let you run the php-cgi as a fastcgi daemon, by specifying -b address:port
  <p>
  See below.
  </p>
  <H3><u>Configuration file for nginx</u></H3>
  <p>
We're going to configure 2 virtual hosts, one for php 5.2 and one for php 5.3. Each one of 
these will access an exclusive fastcgi daemon, running the correct php version we need. Also, a sample
configuration is shown, to route all requests to non-existant files, to a front controller in
index.php (useful for zend framework, yii, symfony, etc).
  </p>  
<pre name="code" class="php">

# Useful to debug rewrite rules and other stuff
error_log  logs/error.log  notice; 

http {
    # Debug rewrite rules
    rewrite_log  on;
}

server {
        listen          80;
        server_name     php53;
        root            /www/php53;
        index           index.php;
        fastcgi_index   index.php;

        location / {
            index index.php;
        }

        location ~ \.htaccess {
            deny all;
        }

        # These lines will allow to redirect any request that does not match
        # an existant file to a front controller (zf, yii, symfony, etc)
        error_page  404 = /index.php;
        if (!-e $request_filename) {
            rewrite ^.*$ /index.php last;
        }

        location ~ \.php {
                # Workaround PHP vulnerability:
                # http://forum.nginx.org/read.php?2,88845,page=3
                try_files $uri =404;
                # Alternatively you can set
                # cgi.fix_pathinfo = false
                # in php.ini
                include /etc/nginx/fastcgi_params;
                keepalive_timeout 0;
                fastcgi_param   SCRIPT_FILENAME  $document_root$fastcgi_script_name;
                fastcgi_pass    127.0.0.1:9001;
        }
}
server {
        listen          80;
        server_name     php52;
        root            /www/php52;
        index           index.php;
        fastcgi_index   index.php;

        location / {
            index index.php;
        }

        location ~ \.htaccess {
            deny all;
        }

        # These lines will allow to redirect any request that does not match
        # an existant file to a front controller (zf, yii, symfony, etc)
        error_page  404 = /index.php;
        if (!-e $request_filename) {
            rewrite ^.*$ /index.php last;
        }
        
        location ~ \.php {
                # Workaround PHP vulnerability:
                # http://forum.nginx.org/read.php?2,88845,page=3
                try_files $uri =404;
                # Alternatively you can set
                # cgi.fix_pathinfo = false
                # in php.ini
                include /etc/nginx/fastcgi_params;
                keepalive_timeout 0;
                fastcgi_param   SCRIPT_FILENAME  $document_root$fastcgi_script_name;
                fastcgi_pass    127.0.0.1:9000;
        }
}
  </pre>
  <H3><u>Start me up!</u></H3>
  <p>
This is a very silly script that will run your fastcgi daemons and nginx. Beware, this is just to show you
how it can be done, I recommend that you adapt this script to your OS, honoring the way init scripts are created
(freebsd has its own way, each linux flavor tend to have its own, etc)
  </p>
  <pre name="code" class="php">
#!/bin/bash
USER=nobody
PHP_52_BIND=127.0.0.1:9000
PHP_53_BIND=127.0.0.1:9001
PHP_52_CGI=/usr/php-5.2/bin/php-cgi
PHP_53_CGI=/usr/php-5.3/bin/php-cgi
PHP_FCGI_CHILDREN=15
PHP_FCGI_MAX_REQUESTS=1000
PHP_CGI_ARGS="- USER=$USER PATH=/usr/bin PHP_FCGI_CHILDREN=$PHP_FCGI_CHILDREN PHP_FCGI_MAX_REQUESTS=$PHP_FCGI_MAX_REQUESTS"
PHP_52_CGI_ARGS="${PHP_CGI_ARGS} ${PHP_52_CGI} -b ${PHP_52_BIND}"
PHP_53_CGI_ARGS="${PHP_CGI_ARGS} ${PHP_53_CGI} -b ${PHP_53_BIND}"

# First kill nginx
killall -q -w -u ${USER} nginx

# Then kill fastcgi daemons
killall -q -w -u ${USER} ${PHP_53_CGI}
killall -q -w -u ${USER} ${PHP_52_CGI}

# Launch fastcgi daemons & nginx
/usr/bin/env -- $PHP_52_CGI_ARGS &
/usr/bin/env -- $PHP_53_CGI_ARGS &
/usr/nginx/sbin/nginx
  </pre>
<p>
That's it. Enjoy your php/nginx installation :)
</p>
              </div>
            </div>
            <div class="mod view-more">
              <div class="inner">
                <a href="articles.html">Read Other Articles</a>
              </div>
              <span class="bottom"><span class="bl"></span><span class="br"></span></span>
            </div>
          </div>
          <div id="sidebar" class="highlight articles-style original">
            <div class="mod simple">
              <span class="top"><span class="tl"></span><span class="tr"></span></span>
              <div class="inner set-height-1">
              	<h2>Articles</h2>
                <div class="hr-1"><hr /></div>
                <ul class="quick-list">
                  <li><a href="ding_bean_lifecycle_init_destroy_post_construct.html">Hooks into the bean lifecycle in the Ding container</a></li>
                  <li><a href="php_asterisk_agi_protocol_tutorial.html">AGI (Asterisk Gateway Interface) Protocol Tutorial And Quick Practical Approach</a></li>
                  <li><a href="php_asterisk_manager_interface_protocol_tutorial_introduction.html">AMI (Asterisk Manager Interface) Protocol Tutorial</a></li>
                  <li><a href="php_mock_global_functions_for_unit_tests_with_phpunit.html">Mocking Global Php 5.3 Functions Using Namespaces</a></li>
                  <li><a href="cross_freebsd_compiler_in_linux.html">Generating A Cross Compiler For Freebsd In Linux</a></li>
                  <li><a href="php_asterisk_listener_example_using_pami_and_ding.html">Making an Asterisk Manager Interface monitor using PHP, PAMI, and Ding (Inversion of control and dependency injection in your php telephony applications)</a></li>
                  <li><a href="php_send_dime_attachment_with_soap_webservice_with_curl.html">Using DIME With SOAP And PHP</a></li>
                  <li><a href="bash_asterisk_manager_interface_client_shell_script.html">Bami: A Proof of concept asterisk manager interface (AMI) client written in bash</a></li>
                  <li><a href="creating_php_cli_standalone_portable_applications_with_pear_dependencies.html"> Creating isolated environments for PHP applications with PEAR dependencies</a></li>
                  <li><a href="php_applications_with_doctrine2_orm_and_ding_di_container.html">Writing PHP applications with Doctrine2 as ORM and Ding as DI container</a></li>
                  <li><a href="configure_postfix_forward_all_email_smtp_gateway.html">Configuring postfix to forward all email to a smtp gateway</a></li>
                  <li><a href="ding_how_to_install_configure_tutorial_introduction.html">Installing and using the Ding DI Container</a></li>
                  <li><a href="pami_introduction_tutorial_how_to_install.html">Getting Started with the PAMI: PHP Asterisk Manager Interface</a></li>
                  <li><a href="pagi_tutorial_create_voip_telephony_application_for_asterisk_with_agi_and_php.html">PAGI: Quick telephony applications using AGI and PHP</a></li>
                </ul>
                <div class="google-ads">
                    <script type="text/javascript">
                    google_ad_client = "ca-pub-6947936742546167";
                    /* 9 */
                    google_ad_slot = "8617829895";
                    google_ad_width = 250;
                    google_ad_height = 250;
                    //-->
                    </script>
                    <script type="text/javascript"
                    src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                    </script>
                </div>
              </div>
              <span class="bottom"><span class="bl"></span><span class="br"></span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footer">
  	<!-- <p>&copy; 2010 Marcelo G. All Rights Reserved. Website design by <a href="http://Digitallabs.tv" target="_blank">Digitallabs.tv</a></p> -->
    <address>Email: <a href="mailto:marcelog@gmail.com">marcelog@gmail.com</a></address>
  </div>
</div>

<!-- config SyntaxHighlighter -->
<script src='../dphighlighter/shCore.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushPhp.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushXml.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushJScript.js' type='text/javascript'></script>
<script src='../dphighlighter/shBrushCss.js' type='text/javascript'></script>
<script language="javascript">
    dp.SyntaxHighlighter.ClipboardSwf = '../dphighlighter/clipboard.swf';
    dp.SyntaxHighlighter.HighlightAll('code');
</script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21070993-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>